<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="UTF-8">
    <link rel="icon" href="/images/logo.png" type="image/x-icon"/>
    <link rel="shortcut icon" href="/images/logo.png" type="image/x-icon"/>

    <title>一站式等保云平台</title>
    <link rel="stylesheet" type="text/css" href="css/style2.0.css">

    <script type="text/javascript" src="/js/utils.js"></script>
    <script type="text/javascript" src="/js/md5.min.js"></script>
    <script type="text/javascript" src="/js/sweetalert2/dist/sweetalert2.all.min.js"></script>

</head>
<style type="text/css">
    ul li {
        font-size: 30px;
        color: #2ec0f6;
    }

    .tyg-p {
        font-size: 14px;
        font-weight: 600px;
    }

    .tyg-div-denglv {
        z-index: 1000;
        float: right;
        position: absolute;
        right: 20%;
        top: 18%;
    }

    .tyg-div-form {
        /* background-color: #23305a; */
        width: 300px;
        height: auto;
        border-radius: 6px;
        margin: 120px auto 0 auto;
        color: #2ec0f6;
        border: 1px solid #23305a;
    }

    .tyg-div-form form {
        padding: 10px;
    }

    .tyg-div-form form button {
        cursor: pointer;
        width: 270px;
        height: 44px;
        margin-top: 25px;
        padding: 0;
        /* background: #2ec0f6; */
        -moz-border-radius: 6px;
        -webkit-border-radius: 6px;
        border-radius: 6px;
        border: 1px solid #2ec0f6;
        -moz-box-shadow: 0 15px 30px 0 rgba(255, 255, 255, .25) inset,
        0 2px 7px 0 rgba(0, 0, 0, .2);
        -webkit-box-shadow: 0 15px 30px 0 rgba(255, 255, 255, .25) inset,
        0 2px 7px 0 rgba(0, 0, 0, .2);
        box-shadow: 0 15px 30px 0 rgba(255, 255, 255, .25) inset,
        0 2px 7px 0 rgba(0, 0, 0, .2);
        font-family: 'PT Sans', Helvetica, Arial, sans-serif;
        font-size: 14px;
        font-weight: 700;
        color: #fff;
        text-shadow: 0 1px 2px rgba(0, 0, 0, .1);
        -o-transition: all .2s;
        -moz-transition: all .2s;
        -webkit-transition: all .2s;
        -ms-transition: all .2s;
    }

    .input-style {
        background: rgba(0, 0, 0, 0);
        margin-left: 10px;
        width: 240px;
        height: 30px;
        font-size: 14px;
        color: white;
        border: none;
        outline: none;
    }

    .inputBox-style {
        display: inline-flex;
        align-items: center;
        height: 30px;
        border: 1px solid #45bdf4;
        margin-top: 20px;
        padding: 5px 5px;
    }

    .button {
        cursor: pointer;
        outline: none;
        border: none;
        width: 70px;
        height: 36px;
        line-height: 36px;
        background-color: #2185d0;
        color: #fff;
        font-size: 1rem;
        text-align: center;
        text-decoration: none;
        border-radius: 6px;
    }

    .button-style {
        cursor: pointer;
        width: 280px;
        height: 40px;
        margin-top: 20px;
        background: #2ec0f6;
        border-radius: 6px;
        border: 1px solid #2ec0f6;
        box-shadow: 0 15px 30px 0 rgb(255 255 255 / 25%) inset, 0 2px 7px 0 rgb(0 0 0 / 20%);
        font-family: 'PT Sans', Helvetica, Arial, sans-serif;
        font-size: 16px;
        text-align: center;
        line-height: 40px;
        font-weight: 700;
        color: #fff;
        text-shadow: 0 1px 2px rgb(0 0 0 / 10%);
        -webkit-transition: all .2s;
    }
</style>
<body>
<div id="contPar" class="contPar">
    <div id="page1" style="z-index:1;">
        <div class="title0" style="left: -15%;">一站式等保云平台</div>
        <div class="title1" style="left: -15%;">一站式等保合规建设、云安全加速平台</div>
<!--        <div class="imgGroug" style="left: 35%;">-->
<!--            <ul>-->
<!--                <img alt="" class="img0 png" src="/images/loginPage1_0.png">-->
<!--                <img alt="" class="img1 png" src="/images/loginPage1_1.png">-->
<!--                <img alt="" class="img2 png" src="/images/loginPage1_2.png">-->
<!--            </ul>-->
<!--        </div>-->
        <img alt="" class="img3 png" style="left: 35%;" src="/images/loginPage1_3.jpg">
    </div>
</div>
<div class="tyg-div-denglv">
    <div id="loginPart" style="display: block;">
        <div class="tyg-div-form">
            <form id="loginFormData" action=""  method="post">
                <div style="width: 100%;display: flex;flex-direction: row;justify-content: space-between;align-items: center;">
                    <h2>欢迎访问</h2><span class="tyg-p">一站式等保云平台</span>
                </div>
                <div class="inputBox-style">
                    <img src="/images/user_blue.svg" width="18px" height="20px">
                    <input class="input-style" type="text" id="username" name="username" placeholder="请输入用户名"
                           maxlength="200" onchange="onRefreshShowOpt()"/>
                </div>
                <div class="inputBox-style">
                    <img src="/images/pwd_blue.svg" width="18px" height="20px">
                    <input class="input-style" type="password" id="password" name="password" placeholder="请输入密码"
                           maxlength="200" onkeydown="onCheckDoLogin()"/>
                </div>
                <div id="optInputBox" style="display: none;">
                    <div class="inputBox-style">
                        <img src="/images/opt_blue.svg" width="18px" height="20px">
                        <input class="input-style" type="text" id="otpCode" name="otpCode" placeholder="请输入OTP动态密码"
                               maxlength="6"/>
                    </div>
                </div>
                <!-- <button type="submit" >登<span style="width:20px;"></span>录</button> -->
                <div class="button-style" onclick="login()">登 录</div>
            </form>
        </div>
    </div>
    <div id="resetPart" style="display: none;">
        <div class="tyg-div-form">
            <form id="resetFormData" action=""  method="post">
                <div style="width: 100%;display: flex;flex-direction: row;justify-content: space-between;align-items: center;">
                    <h2>登录</h2><span class="tyg-p">一站式等保云平台</span>
                </div>
                <div class="inputBox-style">
                    <img src="/images/pwd_blue.svg" width="18px" height="20px">
                    <input class="input-style" type="password" id="resetPassword" name="password" placeholder="请输入新密码"
                           maxlength="200"/>
                </div>
                <div class="inputBox-style">
                    <img src="/images/pwd_blue.svg" width="18px" height="20px">
                    <input class="input-style" type="password" id="confirmPassword" name="confirmPassword"
                           placeholder="请确认密码" maxlength="200" onkeydown="onCheckDoReset()"/>
                </div>
                <div class="button-style" onclick="onResetPwd()">确认修改</div>
            </form>
        </div>
    </div>
<!--    <div id="renewalPart" style="display: none;">-->
<!--        <div class="tyg-div-form">-->
<!--            <form id="renewalFormData" action="" method="post">-->
<!--                <div style="width: 100%;display: flex;flex-direction: row;justify-content: space-between;align-items: center;">-->
<!--                    <h2>续订</h2><span class="tyg-p">一站式等保云平台</span>-->
<!--                </div>-->
<!--                <div class="inputBox-style">-->
<!--                    <img src="/images/code_blue.svg" width="18px" height="20px">-->
<!--                    <input class="input-style" type="text" id="systemCode" name="systemCode" maxlength="200" disabled/>-->
<!--                </div>-->
<!--                <div class="inputBox-style">-->
<!--                    <img src="/images/secret_blue.svg" width="18px" height="20px">-->
<!--                    <input class="input-style" type="text" id="secret" name="secret" placeholder="请输入密钥" maxlength="200"-->
<!--                           onkeydown="onCheckDoRenewal()"/>-->
<!--                </div>-->
<!--                <div class="button-style" onclick="onRenewal()">续订</div>-->
<!--            </form>-->
<!--        </div>-->
<!--    </div>-->
</div>
<!--<script type="text/javascript" src="js/jquery-1.8.0.min.js"></script>-->
<!--<script type="text/javascript" src="js/com.js"></script>-->
<script type="text/javascript" src="js/axios.min.js"></script>
<script type="text/javascript" src="js/requestApi.js"></script>

<script type="text/javascript">

    var tempToken = ""
    var tempCsrfToke = ""
    var tempShowOTP = false
    var showChangePwd = false

    window.onload = function () {
        sessionStorage.setItem("leftSelectCode", "dashboard")
        localStorage.removeItem("ddosSelectNodeId");
        localStorage.removeItem("nfwSelectNodeId");

        onGetRefreshToken()
        onGetToken()
    }

    function onGetRefreshToken() {
        refreshCsrfToken()
        setInterval(function () {
            refreshCsrfToken()
        }, 10 * 60 * 1000)
    }

    function refreshCsrfToken() {
        reqApi("get", "/csrf/token", null, null,
            (res) => {
                tempCsrfToke = res.data.token
            },
        )
    }

    function onGetToken() {
        reqApi("get", "/?token=1", null, null,
            (res) => {
                tempToken = res.data.token
            })
    }

    function onRefreshShowOpt() {
        var tempUserName = document.getElementById('username').value
        var tempFormData = new FormData();
        tempFormData.append("username", tempUserName)
        reqApi("post","/checkOTP",tempFormData,null,
        		(res)=>{
        			var optInputBox =  document.getElementById("optInputBox")
        			tempShowOTP = res.data.requireOTP
        			if(tempShowOTP){
        				optInputBox.style.display = "block"
        			}else{
        				optInputBox.style.display = "none"
        			}
        		}
        	)
    }

    function onCheckDoLogin(frm, event) {
        var event = window.event ? window.event : event;
        if (event.keyCode == 13) {
            login();
        }
    }

    function login() {
        var tempUserName = document.getElementById('username').value
        var tempPassword = document.getElementById('password').value
        tempPassword = md5(tempPassword.trim());
        var tempFormData = new FormData();
        tempFormData.append("username", tempUserName)
        tempFormData.append("password", tempPassword)
        tempFormData.append("token", tempToken)
        tempFormData.append("csrfToken", tempCsrfToke)
        if (tempShowOTP) {
            var tempOTPCode = document.getElementById('otpCode').value
            tempFormData.append("otpCode", tempOTPCode)
        }
        reqApi("post", "", tempFormData, null,
            (res) => {
                if (res.data.from.length == 0) {
                    window.location = "/dashboard";
                } else {
                    window.location = this.data.from;
                }
            },
            (res) => {
                if (res.data.from == "/updatePwd") { //如果是密码过期
                    teaweb.warn(res.message, function () {
                        var loginPart = document.getElementById("loginPart")
                        var resetPwdPart = document.getElementById("resetPart")
                        loginPart.style.display = "none"
                        resetPwdPart.style.display = "block"
                        onGetRefreshToken()
                        onGetToken()
                    })
                } else if (res.data.from == "/renewal") { //到期 续订
                    teaweb.warn(res.message, function () {
                        var loginPart = document.getElementById("loginPart")
                        var resetPwdPart = document.getElementById("resetPart")
                        loginPart.style.display = "none"
                        resetPwdPart.style.display = "none"
                        console.log(res.data.systemCode)
                        document.getElementById("systemCode").value = res.data.systemCode

                    })
                }else if (res.data.from == "/页面过期") { //刷新页面
                    teaweb.warn(res.message, function () {
                        window.location.reload()
                    }) 
                }else {
                    teaweb.warn(res.message, function () {
                        onGetRefreshToken()
                        onGetToken()
                    })
                }
            }
        )
    }

    function onCheckDoReset(frm, event) {
        var event = window.event ? window.event : event;
        if (event.keyCode == 13) {
            onResetPwd();
        }
    }

    function onResetPwd() {
        var tempPassword = document.getElementById('resetPassword').value
        var tempConfirmPassword = document.getElementById('confirmPassword').value
        tempPassword = tempPassword.trim();
        tempConfirmPassword = tempConfirmPassword.trim();
        var tempFormData = new FormData();
        tempFormData.append("password", tempPassword)
        tempFormData.append("confirmPassword", tempConfirmPassword)
        tempFormData.append("token", tempToken)
        tempFormData.append("csrfToken", tempCsrfToke)
        reqApi("post", "/updatePwd", tempFormData, null,
            (res) => {
                teaweb.success("修改成功", function () {
                    var loginPart = document.getElementById("loginPart")
                    var resetPwdPart = document.getElementById("resetPart")
                    document.getElementById('password').value = ""
                    resetPwdPart.style.display = "none"
                    loginPart.style.display = "block"
                    onGetRefreshToken()
                    onGetToken()
                })
            },
            (res) => {
                teaweb.warn(res.message, function () {
                    onGetRefreshToken()
                    onGetToken()
                })
            }
        )
    }

    function onRenewal() {
        var secret = document.getElementById('secret').value

        var tempFormData = new FormData();
        tempFormData.append("secret", secret)
        reqApi("post", "/renewal", tempFormData, null,
            (res) => {
                teaweb.success("修改成功", function () {
                    var loginPart = document.getElementById("loginPart")
                    var renewalPart = document.getElementById("renewalPart")
                    var resetPwdPart = document.getElementById("resetPart")
                    document.getElementById('password').value = ""
                    resetPwdPart.style.display = "none"
                    renewalPart.style.display = "none"
                    loginPart.style.display = "block"
                    onGetRefreshToken()
                    onGetToken()
                })
            },
            (res) => {
                teaweb.warn(res.message, function () {
                    onGetRefreshToken()
                    onGetToken()
                })
            }
        )
    }
</script>
</body>
</html>