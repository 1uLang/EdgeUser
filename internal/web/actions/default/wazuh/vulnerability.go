// 主机防护使用wazuh组件

package wazuh

import (
	"github.com/1uLang/zhiannet-api/wazuh/model/agents"
	"github.com/1uLang/zhiannet-api/wazuh/server"
	"github.com/TeaOSLab/EdgeUser/internal/web/actions/actionutils"
)

type VulnerabilityAction struct {
	actionutils.ParentAction
}

func (this *VulnerabilityAction) Init() {
	this.Nav("", "", "vulnerability")
}

func (this *VulnerabilityAction) RunGet(params struct {
	Agent    string
	Severity string
}) {

	this.Data["severitys"] = []map[string]string{
		{"k": "Critical", "v": "危急"},
		{"k": "High", "v": "高危"},
		{"k": "Medium", "v": "中危"},
		{"k": "Low", "v": "低危"},
	}

	err := InitAPIServer()
	if err != nil {
		this.ErrorPage(err)
		return
	}
	agent, err := server.AgentList(&agents.ListReq{
		UserId: this.UserId(true),
	})
	if err != nil {
		this.ErrorPage(err)
		return
	}

	if len(agent.AffectedItems) == 0 {
		this.Data["errorMsg"] = "请先添加资产"
		this.Data["agents"] = []map[string]string{}
		this.Data["vulnerabilitys"] = []map[string]string{}
		this.Data["severity"] = params.Severity
		this.Show()
		return
	}
	if params.Agent == "" {
		params.Agent = agent.AffectedItems[0].ID
	}
	list, err := server.VulnerabilityList(agents.ESListReq{
		Agent:    params.Agent,
		Severity: params.Severity,
		Limit:    1,
		Offset:   0,
		//Start:    time.Now().AddDate(0, 0, -1).Unix(),
		//End:      time.Now().Unix(),
		//Start: 1630982235, End: 1631068635,
		//AdminUserId: this.AdminId()
	})
	if err != nil {
		this.ErrorPage(err)
		return
	}

	page := this.NewPage(int64(list.Total))
	this.Data["page"] = page.AsHTML()

	list, err = server.VulnerabilityList(agents.ESListReq{
		Agent:    params.Agent,
		Severity: params.Severity,
		Limit:    int(page.Size),
		Offset:   int(page.Offset),
		//Start:    time.Now().AddDate(0, 0, -1).Unix(),
		//End:      time.Now().Unix(),
		//Start: 1630982235, End: 1631068635,
	})
	if err != nil {
		this.ErrorPage(err)
		return
	}
	this.Data["vulnerabilitys"] = list.Hits

	this.Data["agents"] = agent.AffectedItems

	this.Data["agent"] = params.Agent
	this.Data["severity"] = params.Severity
	this.Show()
}
